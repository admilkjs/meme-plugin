name: è‡ªåŠ¨å‘å¸ƒå¹¶æ›´æ–° PR å†…å®¹

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  check-commit-message:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}

    steps:
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›è¡Œç‰ˆæœ¬æ›´æ–°
        id: check
        run: |
          latest_commit_message="${{ github.event.head_commit.message }}"
          if [[ "$latest_commit_message" =~ ^chore:\ å‘å¸ƒç‰ˆæœ¬.* ]]; then
            echo "å·²æœ‰ç‰ˆæœ¬æ›´æ–°ï¼Œè·³è¿‡ç‰ˆæœ¬æ›´æ–°"
            echo "::set-output name=should_release::false"
          elif git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '.pre-commit-config.yaml'; then
            echo "æ›´æ–°äº†pre-commitä¾èµ–, è·³è¿‡ç‰ˆæœ¬æ›´æ–°"
            echo "::set-output name=should_release::false"
          else
            echo "è¿›è¡Œç‰ˆæœ¬æ›´æ–°"
            echo "::set-output name=should_release::true"
          fi

  auto-release:
    needs: check-commit-message
    if: needs.check-commit-message.outputs.should_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è¿è¡Œ release-it
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm release --ci --config .release-it.json

      - name: æäº¤æ›´æ–°
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(pnpm pkg get version | tr -d '"')
          RELEASE_BRANCH="release/v$VERSION"
          git checkout -b $RELEASE_BRANCH || git checkout $RELEASE_BRANCH
          git add CHANGELOG.md package.json
          git commit -m "chore: å‘å¸ƒç‰ˆæœ¬ v$VERSION ğŸš€" || echo "æ— æ›´æ”¹éœ€è¦æäº¤"
          git push origin $RELEASE_BRANCH --force || git push -u origin $RELEASE_BRANCH --force

      - name: åˆ›å»ºæˆ–æ›´æ–° PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(pnpm pkg get version | tr -d '"')
          RELEASE_BRANCH="release/v$VERSION"
          CHANGELOG=$(awk 'BEGIN {flag=0}
            /^## / {if (flag) exit; flag=1}
            flag {print}' CHANGELOG.md)
          BODY=$(printf "# æ›´æ–°æ—¥å¿—\n\n%s\n" "$CHANGELOG")
          EXISTING_PR=$(gh pr list --head "$RELEASE_BRANCH" --base main --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --head "$RELEASE_BRANCH" \
              --base main \
              --title "chore: å‘å¸ƒç‰ˆæœ¬ v$VERSION ğŸš€" \
              --body "$BODY"
          else
            gh pr edit "$EXISTING_PR" \
              --body "$BODY"
          fi
